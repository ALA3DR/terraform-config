#!/usr/bin/env ruby

require 'optparse'
require 'pathname'

def main
  options = {
    repository: '',
    iv: '',
    key: '',
    salt: ''
  }

  OptionParser.new do |opts|
    opts.on('--repository=REPOSITORY', String) do |v|
      options[:repository] = v.strip
    end

    opts.on('--iv=IV', String) do |v|
      options[:iv] = v.strip
    end

    opts.on('--key=KEY', String) do |v|
      options[:key] = v.strip
    end

    opts.on('--salt=SALT', String) do |v|
      options[:salt] = v.strip
    end
  end.parse!

  options.clone.each do |key, value|
    fail "missing value for --#{key.gsub('_', '-')}" if value.strip.empty?
  end

  %i[iv key salt].each do |key_suffix|
    unless system(%W[
      travis env set
        DOCKER_CLIENT_CONFIG_ENC_#{key_suffix.to_s.upcase}
        #{options[key_suffix]}
        --private
        --repo #{options[:repository]}
    ].join(' '))
      fail "failed to set env var for #{key_suffix}"
    end
  end

  0
end

exit(main) if $PROGRAM_NAME == __FILE__
