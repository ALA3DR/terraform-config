#!/usr/bin/env bash
set -o errexit
set -o pipefail

main() {
  local halp='^(-h|--help|help)$'
  for arg in "${@}"; do
    if [[ "${arg}" =~ $halp ]]; then
      __usage
      exit 0
    fi
  done

  if [[ $# -lt 1 ]]; then
    __usage
    exit 1
  fi

  export PACKET_PROJECT_ID="${1}"

  [[ "${PACKET_AUTH_TOKEN}" ]] || {
    echo Missing \$PACKET_AUTH_TOKEN >&2
    exit 1
  }

  if [[ "${DEBUG}" ]]; then
    set -o xtrace
  fi

  : "${PACKET_PRIVATE_NETWORK_NAME:=private}"
  : "${PACKET_PRIVATE_NETWORK_FACILITY:=sjc1}"

  local vlan_id
  vlan_id="$(__fetch_vlan \
    "${PACKET_PRIVATE_NETWORK_NAME}" "${PACKET_PRIVATE_NETWORK_FACILITY}"
  )"

  if [[ "${vlan_id}" ]]; then
    echo "===> Found existing network ${vlan_id}" >&2
    echo "     name=${PACKET_PRIVATE_NETWORK_NAME}" >&2
    echo "     facility=${PACKET_PRIVATE_NETWORK_FACILITY}" >&2
    exit 0
  fi

  vlan_id="$(__create_vlan \
    "${PACKET_PRIVATE_NETWORK_NAME}" "${PACKET_PRIVATE_NETWORK_FACILITY}"
  )"

  echo "===> Created network ${vlan_id}" >&2
  echo "     name=${PACKET_PRIVATE_NETWORK_NAME}" >&2
  echo "     facility=${PACKET_PRIVATE_NETWORK_FACILITY}" >&2
}

__fetch_vlan() {
  local name="${1}"
  local fac="${2}"

  __packet_curl \
    -f \
    -s \
    -X GET \
    "https://api.packet.net/projects/${PACKET_PROJECT_ID}/virtual-networks" |
      jq -r ".virtual_networks | .[] \
      | select(.description==\"${name}\" and .facility_code==\"${fac}\") \
      | .id" | head -n 1
}

__create_vlan() {
  local name="${1}"
  local fac="${2}"
  local postdata
  postdata="$(echo '{
      "description": "'${name}'",
      "facility_id": "'${fac}'"
    }' | jq -M -c .
  )"

  __packet_curl \
    -f \
    -s \
    -X POST \
    -d "${postdata}" \
    -H 'Content-Type: application/json;charset=utf-8' \
    "https://api.packet.net/projects/${PACKET_PROJECT_ID}/virtual-networks"  |
      jq -r '.id'
}

__packet_curl() {
  curl \
    -n \
    -H 'Accept: application/json' \
    -H "X-Auth-Token: ${PACKET_AUTH_TOKEN}" \
    "${@}"
}

__usage() {
  local prog
  prog="$(basename "${0}")"
  echo "Usage: ${prog} <app>" >&2
  echo >&2
  echo "Ensure virtual network exists in Packet <project-id-uuid>" >&2
  echo >&2
  echo "${prog} zzzzzzzz-zzzz-zzzz-zzzz-zzzzzzzzzzzz" >&2
}

main "$@"
