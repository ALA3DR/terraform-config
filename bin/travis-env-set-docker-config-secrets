#!/usr/bin/env ruby

require 'optparse'
require 'pathname'
require 'base64'

def main
  options = {
    repository: '',
    client_config_url: '',
    docker_host: ''
  }

  OptionParser.new do |opts|
    opts.on('--repository=REPOSITORY', String) do |v|
      options[:repository] = v.strip
    end

    opts.on('--docker-host=DOCKER_HOST', String) do |v|
      options[:docker_host] = v.strip
    end

    opts.on('--client-config-url=CLIENT_CONFIG_URL', String) do |v|
      options[:client_config_url] = v.strip
    end
  end.parse!

  options.clone.each do |key, value|
    fail "missing value for --#{key.gsub('_', '-')}" if value.strip.empty?
  end

  unless system(%W[
    travis env set
      DOCKER_CLIENT_CONFIG_URL #{Base64.strict_encode64(options[:client_config_url])}
      --repo #{options[:repository]}
  ].join(' '))
    fail 'failed to set DOCKER_CLIENT_CONFIG_URL'
  end

  unless system(%W[
    travis env set
      DOCKER_HOST #{options[:docker_host]}
      --private
      --repo #{options[:repository]}
  ].join(' '))
    fail 'failed to set DOCKER_HOST'
  end

  0
end

exit(main) if $PROGRAM_NAME == __FILE__
