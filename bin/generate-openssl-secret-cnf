#!/usr/bin/env bash
set -o errexit

main() {
  local secret="${1}"
  local outdir="${2}"

  [[ "${secret}" ]] || {
    echo 'Missing <secret> first positional arg' >&2
    exit 1
  }

  local outcnf="${outdir}/openssl-secret.cnf"

  mkdir -p "${outdir}"
  openssl enc -aes-256-cbc -k "${secret}" -P -md sha1 \
    >"${outdir}/openssl-secret.cnf"

  awk -F= '/iv/ { print $2 }' <"${outdir}/openssl-secret.cnf" \
    >"${outdir}/openssl-iv"
  awk -F= '/key/ { print $2 }' <"${outdir}/openssl-secret.cnf" \
    >"${outdir}/openssl-key"
  awk -F= '/salt/ { print $2 }' <"${outdir}/openssl-secret.cnf" \
    >"${outdir}/openssl-salt"
}

main "${@}"
