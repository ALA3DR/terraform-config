#!/usr/bin/env bash

set -o errexit
set -o pipefail

main() {
  if [[ $# -ne 2 ]]; then
    echo "Usage: $(basename "${0}") <repo-slug> <heroku-app>" >&2
    exit 1
  fi

  local repo_slug="${1}"
  local heroku_app="${2}"
  local tmp_dir
  tmp_dir="$(mktemp -d)"
  trap 'rm -rf '"${tmp_dir}" EXIT QUIT TERM INT

  echo "Deploying ${repo_slug} to ${heroku_app}"
  __heroku_deploy "${repo_slug}" "${heroku_app}" | tee "${tmp_dir}/deploy.json"

  local output_stream_url
  output_stream_url="$(jq -r .output_stream_url <"${tmp_dir}/deploy.json")"

  echo "Streaming deploy output"
  curl -f "${output_stream_url}"
}

__heroku_deploy() {
  local repo_slug="${1}"
  local heroku_app="${2}"

  curl -s -X POST "https://api.heroku.com/apps/${heroku_app}/builds" \
    -d "{
      \"source_blob\": {
        \"url\": \"https://github.com/${repo_slug}/archive/master.tar.gz\",
        \"version\": \"master\"
      }
    }" \
    -H "Authorization: Bearer ${HEROKU_API_KEY}" \
    -H "Accept: application/vnd.heroku+json; version=3" \
    -H "Content-Type: application/json"
}

main "${@}"
